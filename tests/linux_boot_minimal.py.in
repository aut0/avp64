#!/usr/bin/env python3

##############################################################################
#                                                                            #
# Copyright 2025 Nils Bosbach                                                #
#                                                                            #
# This software is licensed under the MIT license.                           #
# A copy of the license can be found in the LICENSE file at the root         #
# of the source tree.                                                        #
#                                                                            #
##############################################################################

import sys
import pexpect
import time

sim='$<TARGET_FILE:avp64_minimal>'
cfg='@config@'

properties = {
    'system.term0.backends': 'term',
    'system.throttle.rtf': '0',
}

cmdline = f'{sim} -f {cfg} ' + ' '.join([f'-c {prop}={properties[prop]}' for prop in properties])

print(cmdline)

p = pexpect.spawn(cmdline, logfile=sys.stdout, timeout=None, encoding='utf-8')

# did all secondary cpus boot?
for cpu in range(1, @nrcpu@):
    p.expect(f'CPU{cpu}: Booted secondary processor 0x000000000{cpu}')

# did our drivers initialize?
p.expect('10009000.uart: ttyAMA0 at MMIO 0x10009000')
p.expect('timeriomem_rng 10007000.rng: 32bits')
p.expect('smsc911x 10010000.lan9118 eth0')
p.expect('rtc-ds1742 1000e000.rtc: registered as rtc0')
p.expect('mmc0: SDHCI controller on 1000d000.mmc')
p.expect('mmc0: new SDHC card at address 0000')

# did we get a login prompt?
p.expect('avp64 login:')
p.sendline('root')

# can we run commands?
p.expect('# ')
p.sendline('uname')
p.expect('Linux')

# did all processors boot up?
p.expect('# ')
p.sendline('cat /proc/cpuinfo')
for cpu in range(@nrcpu@):
    p.expect('processor')

# test ok - shut down simulation
p.sendline('devmem 0x10008000 32 1')
p.expect(pexpect.EOF)
